<!-- Mermaid.js -->
<script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
<script>
    // Initialize Mermaid immediately
    mermaid.initialize({
        startOnLoad: true,
        theme: 'default',
        securityLevel: 'loose',
        themeVariables: {
            primaryColor: '#5f27cd',
            primaryTextColor: '#fff',
            primaryBorderColor: '#5f27cd',
            lineColor: '#333',
            secondaryColor: '#eeeeee',
            tertiaryColor: '#f9f9f9',
            background: '#ffffff',
            mainBkg: '#ffffff',
            secondBkg: '#f8f9fa',
            tertiaryBkg: '#dee2e6'
        },
        flowchart: {
            useMaxWidth: true,
            htmlLabels: true,
            curve: 'basis'
        },
        sequence: {
            diagramMarginX: 50,
            diagramMarginY: 10,
            actorMargin: 50,
            width: 150,
            height: 65,
            boxMargin: 10,
            boxTextMargin: 5,
            noteMargin: 10,
            messageMargin: 35,
            mirrorActors: true,
            bottomMarginAdj: 1,
            useMaxWidth: true
        },
        gantt: {
            titleTopMargin: 25,
            barHeight: 20,
            fontFamily: '"Open Sans", sans-serif',
            fontSize: 11,
            fontWeight: 'normal',
            gridLineStartPadding: 35,
            numberSectionStyles: 4,
            axisFormat: '%m/%d/%Y'
        }
    });
    
    document.addEventListener('DOMContentLoaded', function() {
        // Convert code blocks with language "mermaid" to mermaid divs
        const mermaidCodeBlocks = document.querySelectorAll('code.language-mermaid');
        mermaidCodeBlocks.forEach(function(codeBlock) {
            const mermaidDiv = document.createElement('div');
            mermaidDiv.className = 'mermaid';
            mermaidDiv.textContent = codeBlock.textContent;
            codeBlock.parentNode.parentNode.replaceChild(mermaidDiv, codeBlock.parentNode);
        });
        
        // Handle all pre.highlight blocks that might contain mermaid
        const allPreBlocks = document.querySelectorAll('pre.highlight');
        allPreBlocks.forEach(function(preBlock) {
            const codeBlock = preBlock.querySelector('code');
            if (codeBlock) {
                const content = codeBlock.textContent.trim();
                // More aggressive detection of mermaid content
                if (content.includes('graph TB') || content.includes('graph TD') || content.includes('graph LR') || 
                    content.includes('timeline') || content.includes('flowchart') || content.includes('%%{init:') ||
                    content.includes('subgraph') || content.includes('-->') || content.includes('--&gt;')) {
                    
                    const mermaidDiv = document.createElement('div');
                    mermaidDiv.className = 'mermaid';
                    // Decode HTML entities
                    mermaidDiv.innerHTML = content.replace(/--&gt;/g, '-->').replace(/&lt;/g, '<').replace(/&gt;/g, '>');
                    preBlock.parentNode.replaceChild(mermaidDiv, preBlock);
                }
            }
        });
        
        // Force re-render of all mermaid diagrams
        setTimeout(function() {
            if (typeof mermaid !== 'undefined') {
                try {
                    const mermaidElements = document.querySelectorAll('.mermaid');
                    mermaidElements.forEach(function(element) {
                        element.removeAttribute('data-processed');
                    });
                    mermaid.init(undefined, '.mermaid');
                } catch (error) {
                    console.log('Mermaid initialization error:', error);
                }
            }
        }, 100);
    });
</script>
